<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="633px" preserveAspectRatio="none" style="width:956px;height:633px;" version="1.1" viewBox="0 0 956 633" width="956px" zoomAndPan="magnify"><defs><filter height="300%" id="fqajjqcobh8c7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="442" x="257.5" y="28.6855">Sign-in with Google Design (Auth code with PKCE flow)</text><rect fill="#FFFFFF" filter="url(#fqajjqcobh8c7)" height="96.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="749.5" y="210.6563"/><rect fill="#FFFFFF" filter="url(#fqajjqcobh8c7)" height="30.3516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="920.5" y="246.0078"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="240" x2="240" y1="76.25" y2="591.5234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="428.5" x2="428.5" y1="76.25" y2="591.5234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="754.5" x2="754.5" y1="76.25" y2="591.5234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="925" x2="925" y1="76.25" y2="591.5234"/><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="169" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="176" y="61.1738">Mobile App Browser</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="169" y="590.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="176" y="612.0566">Mobile App Browser</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="360.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="367.5" y="61.1738">Flask Auth Service</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="360.5" y="590.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="367.5" y="612.0566">Flask Auth Service</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="144" x="680.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="687.5" y="61.1738">Google Auth Service</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="144" x="680.5" y="590.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="687.5" y="612.0566">Google Auth Service</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="902" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="909" y="61.1738">User</text><rect fill="#FEFECE" filter="url(#fqajjqcobh8c7)" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="902" y="590.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="909" y="612.0566">User</text><rect fill="#FFFFFF" filter="url(#fqajjqcobh8c7)" height="96.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="749.5" y="210.6563"/><rect fill="#FFFFFF" filter="url(#fqajjqcobh8c7)" height="30.3516" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="920.5" y="246.0078"/><polygon fill="#A80036" points="416.5,117.7773,426.5,121.7773,416.5,125.7773,420.5,121.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240.5" x2="422.5" y1="121.7773" y2="121.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="252.5" y="116.9209">A.1 request authentication...</text><path d="M433,91.25 L433,133.25 L550,133.25 L550,101.25 L540,91.25 L433,91.25 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M540,91.25 L540,101.25 L550,101.25 L540,91.25 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="439" y="109.7451">create random(v)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="439" y="126.0967">$ = sha256(v)</text><polygon fill="#A80036" points="251.5,166.3047,241.5,170.3047,251.5,174.3047,247.5,170.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="245.5" x2="427.5" y1="170.3047" y2="170.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="293" y="165.4482">A.2 redirect ...</text><path d="M158,147.9531 L158,173.9531 L231,173.9531 L231,157.9531 L221,147.9531 L158,147.9531 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M221,147.9531 L221,157.9531 L231,157.9531 L221,147.9531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="164" y="166.4482">forward $</text><polygon fill="#A80036" points="737.5,206.6563,747.5,210.6563,737.5,214.6563,741.5,210.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240.5" x2="743.5" y1="210.6563" y2="210.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="412.5" y="205.7998">A.3 ...at Google Login with $</text><path d="M764,188.3047 L764,214.3047 L825,214.3047 L825,198.3047 L815,188.3047 L764,188.3047 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M815,188.3047 L815,198.3047 L825,198.3047 L815,188.3047 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="770" y="206.7998">store $</text><polygon fill="#A80036" points="908.5,242.0078,918.5,246.0078,908.5,250.0078,912.5,246.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="759.5" x2="914.5" y1="246.0078" y2="246.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="776.5" y="241.1514">A.4 returns login page</text><polygon fill="#A80036" points="770.5,272.3594,760.5,276.3594,770.5,280.3594,766.5,276.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="764.5" x2="924.5" y1="276.3594" y2="276.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="774" y="271.5029">A.5 submits credentials</text><polygon fill="#A80036" points="251.5,302.7109,241.5,306.7109,251.5,310.7109,247.5,306.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="245.5" x2="753.5" y1="306.7109" y2="306.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="374.5" y="301.8545">A.6 return deep link to App with auth_code</text><polygon fill="#A80036" points="416.5,383.0625,426.5,387.0625,416.5,391.0625,420.5,387.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240.5" x2="422.5" y1="387.0625" y2="387.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="255.5" y="382.2061">B.1 redirect with auth_code</text><polygon fill="#A80036" points="742.5,442.9414,752.5,446.9414,742.5,450.9414,746.5,446.9414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="428.5" x2="748.5" y1="446.9414" y2="446.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="440.5" y="442.085">B.2 exchange for token with (client_id, v, auth_code)</text><path d="M759,400.0625 L759,475.0625 L874,475.0625 L874,410.0625 L864,400.0625 L759,400.0625 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M864,400.0625 L864,410.0625 L874,410.0625 L864,400.0625 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="765" y="418.5576">validate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="765" y="434.9092">- client id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="765" y="451.2607">- $ == sha256(v)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="765" y="467.6123">- auth_code</text><polygon fill="#A80036" points="439.5,515.9961,429.5,519.9961,439.5,523.9961,435.5,519.9961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="433.5" x2="753.5" y1="519.9961" y2="519.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="450.5" y="515.1396">B.3 return (openid, access_token, refresh_token)</text><path d="M274,489.4688 L274,531.4688 L419,531.4688 L419,499.4688 L409,489.4688 L274,489.4688 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M409,489.4688 L409,499.4688 L419,499.4688 L409,489.4688 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="280" y="507.9639">openid, refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="280" y="524.3154">register session_id</text><polygon fill="#A80036" points="251.5,564.5234,241.5,568.5234,251.5,572.5234,247.5,568.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="245.5" x2="427.5" y1="568.5234" y2="568.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="291.5" y="563.667">B.4 session_id</text><path d="M8,546.1719 L8,572.1719 L232,572.1719 L232,556.1719 L222,546.1719 L8,546.1719 " fill="#FBFB77" filter="url(#fqajjqcobh8c7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M222,546.1719 L222,556.1719 L232,556.1719 L222,546.1719 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="14" y="564.667">close browser(via Deeplink handler)</text><!--MD5=[bc6864b431f0900ba2a3d51e8e9431a9]
@startuml
skinparam SequenceMessageAlignment center

title Sign-in with Google Design (Auth code with PKCE flow)
"Mobile App Browser" -> "Flask Auth Service" : A.1 request authentication...
note right
create random(v)
$ = sha256(v)
end note
"Mobile App Browser" <- "Flask Auth Service" : A.2 redirect ...
note left: forward $

"Mobile App Browser" -> "Google Auth Service": A.3 ...at Google Login with $
note right: store $
activate "Google Auth Service"
"User" <- "Google Auth Service": A.4 returns login page
activate "User"
"User" -> "Google Auth Service": A.5 submits credentials
deactivate "User"
"Mobile App Browser" <- "Google Auth Service" : A.6 return deep link to App with auth_code
deactivate "Google Auth Service"
|||
|||
"Mobile App Browser" -> "Flask Auth Service" : B.1 redirect with auth_code
"Flask Auth Service" -> "Google Auth Service": B.2 exchange for token with (client_id, v, auth_code)
note right
    validate 
    - client id
    - $ == sha256(v)
    - auth_code
end note
"Google Auth Service" -> "Flask Auth Service": B.3 return (openid, access_token, refresh_token)
note left
    openid, refresh_token
    register session_id
end note
"Flask Auth Service" -> "Mobile App Browser": B.4 session_id
note left
close browser(via Deeplink handler)
end note

@enduml

PlantUML version 1.2020.10(Sun May 17 05:35:57 EDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10
Operating System: Windows 10
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>